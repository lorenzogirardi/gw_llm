# Kong LLM Gateway - Declarative Configuration
# DB-less mode using custom bedrock-proxy plugin
# Compatible with Claude Code

_format_version: "3.0"
_transform: true

# -----------------------------------------------------------------------------
# Services
# -----------------------------------------------------------------------------

services:
  - name: llm-service
    url: https://bedrock-runtime.us-west-1.amazonaws.com
    connect_timeout: 60000
    read_timeout: 120000
    write_timeout: 120000

# -----------------------------------------------------------------------------
# Routes
# -----------------------------------------------------------------------------

routes:
  # Chat completions (default Sonnet) - Claude Code compatible
  - name: chat-route
    service: llm-service
    paths:
      - /v1/chat/completions
      - /v1/messages
    methods:
      - POST

  # Opus 4.5 route
  - name: opus-route
    service: llm-service
    paths:
      - /v1/chat/opus
    methods:
      - POST

  # Sonnet 4 route
  - name: sonnet-route
    service: llm-service
    paths:
      - /v1/chat/sonnet
    methods:
      - POST

  # Haiku route
  - name: haiku-route
    service: llm-service
    paths:
      - /v1/chat/haiku
    methods:
      - POST

  # Health check
  - name: health-route
    service: llm-service
    paths:
      - /health
    methods:
      - GET

# -----------------------------------------------------------------------------
# Plugins
# -----------------------------------------------------------------------------

plugins:
  # Prometheus metrics
  - name: prometheus
    config:
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true

  # Health endpoint
  - name: request-termination
    route: health-route
    config:
      status_code: 200
      body: '{"status":"healthy","service":"kong-llm-gateway"}'

  # Key Authentication
  - name: key-auth
    route: chat-route
    config:
      key_names: [apikey, X-API-Key, Authorization]
      hide_credentials: true

  - name: key-auth
    route: opus-route
    config:
      key_names: [apikey, X-API-Key]
      hide_credentials: true

  - name: key-auth
    route: sonnet-route
    config:
      key_names: [apikey, X-API-Key]
      hide_credentials: true

  - name: key-auth
    route: haiku-route
    config:
      key_names: [apikey, X-API-Key]
      hide_credentials: true

  # Bedrock Proxy - Chat (Haiku default for now)
  # Uses cross-region inference profile for on-demand throughput
  - name: bedrock-proxy
    route: chat-route
    config:
      default_model: us.anthropic.claude-haiku-4-5-20251001-v1:0
      aws_region: us-west-1
      timeout: 120000

  # Bedrock Proxy - Opus 4.5
  - name: bedrock-proxy
    route: opus-route
    config:
      default_model: us.anthropic.claude-opus-4-5-20251101-v1:0
      aws_region: us-west-1
      timeout: 120000

  # Bedrock Proxy - Sonnet 4
  - name: bedrock-proxy
    route: sonnet-route
    config:
      default_model: us.anthropic.claude-sonnet-4-20250514-v1:0
      aws_region: us-west-1
      timeout: 120000

  # Bedrock Proxy - Haiku 4.5
  - name: bedrock-proxy
    route: haiku-route
    config:
      default_model: us.anthropic.claude-haiku-4-5-20251001-v1:0
      aws_region: us-west-1
      timeout: 60000

  # Rate limiting
  - name: rate-limiting
    route: chat-route
    config:
      minute: 60
      policy: local

  - name: rate-limiting
    route: opus-route
    config:
      minute: 30
      policy: local

  - name: rate-limiting
    route: sonnet-route
    config:
      minute: 60
      policy: local

  - name: rate-limiting
    route: haiku-route
    config:
      minute: 100
      policy: local

# -----------------------------------------------------------------------------
# Consumers
# -----------------------------------------------------------------------------

consumers:
  - username: developer
    custom_id: dev-team

  - username: production
    custom_id: prod-team

# -----------------------------------------------------------------------------
# API Keys
# -----------------------------------------------------------------------------

keyauth_credentials:
  - consumer: developer
    key: CHANGE_ME_DEVELOPER_KEY

  - consumer: production
    key: CHANGE_ME_PRODUCTION_KEY
