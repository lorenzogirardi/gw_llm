name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-west-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-west-1.amazonaws.com

jobs:
  # Security scan for secrets
  security-scan:
    name: Security Scan (Secrets)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  # Trivy security scan (vulnerabilities + IaC)
  trivy-scan:
    name: Trivy Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
          format: 'table'

      - name: Run Trivy IaC scanner (Terraform)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'infra/terraform'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          format: 'table'
          trivyignores: '.trivyignore'

  # Checkov IaC security scan
  checkov-scan:
    name: Checkov IaC Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra/terraform
          framework: terraform
          soft_fail: true
          # Skip checks with documented justifications:
          # CKV_AWS_144: S3 cross-region replication - not needed for POC
          # CKV_AWS_145: S3 KMS encryption - using AES256
          # CKV2_AWS_5: ALB with WAF - CloudFront handles WAF
          # CKV_AWS_355: IAM wildcard - required for bedrock:List*/Get*, cloudwatch:PutMetricData
          # CKV_AWS_79: IMDSv2 - FIXED in NAT instance
          # CKV_AWS_8: EBS encryption - NAT instance uses ephemeral storage
          # CKV_AWS_126: EC2 detailed monitoring - not needed for NAT instance
          # CKV_AWS_135: EBS optimized - t3.nano doesn't support it
          # CKV_AWS_88: EC2 public IP - NAT instance requires public IP
          # CKV_TF_1: Module commit hash - using version tags
          skip_check: CKV_AWS_144,CKV_AWS_145,CKV2_AWS_5,CKV_AWS_355,CKV_AWS_8,CKV_AWS_126,CKV_AWS_135,CKV_AWS_88,CKV_TF_1
          output_format: cli
          download_external_modules: true

  # Terraform validation
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infra/terraform/

      - name: Terraform Init (POC)
        working-directory: infra/terraform/environments/poc
        run: terraform init -backend=false

      - name: Terraform Validate (POC)
        working-directory: infra/terraform/environments/poc
        run: terraform validate

  # Build Grafana image
  build-grafana:
    name: Build Grafana Image
    runs-on: ubuntu-latest
    needs: [security-scan, trivy-scan, checkov-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Grafana image
        working-directory: infra/grafana
        run: |
          docker build --platform linux/amd64 -t ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:${{ github.sha }} .

      - name: Trivy scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ env.ECR_REGISTRY }}/grafana-llm-gateway:${{ github.sha }}'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'
          ignore-unfixed: true
          format: 'table'

      - name: Push Grafana image
        working-directory: infra/grafana
        run: |
          docker tag ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:${{ github.sha }} ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:latest
          docker push ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:${{ github.sha }}
          docker push ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:latest

  # Deploy to POC (manual trigger or main branch)
  deploy-poc:
    name: Deploy to POC
    runs-on: ubuntu-latest
    needs: [terraform-validate, build-grafana]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: poc
    steps:
      - uses: actions/checkout@v6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Force deploy Grafana
        run: |
          aws ecs update-service \
            --cluster kong-llm-gateway-poc \
            --service grafana \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for deployment
        run: |
          aws ecs wait services-stable \
            --cluster kong-llm-gateway-poc \
            --services grafana \
            --region ${{ env.AWS_REGION }}
