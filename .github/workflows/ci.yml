name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-west-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-west-1.amazonaws.com

jobs:
  # Security scan for secrets
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  # Terraform validation
  terraform-validate:
    name: Terraform Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.0

      - name: Terraform Format Check
        run: terraform fmt -check -recursive infra/terraform/

      - name: Terraform Init (POC)
        working-directory: infra/terraform/environments/poc
        run: terraform init -backend=false

      - name: Terraform Validate (POC)
        working-directory: infra/terraform/environments/poc
        run: terraform validate

  # Build Grafana image
  build-grafana:
    name: Build Grafana Image
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and push Grafana image
        working-directory: infra/grafana
        run: |
          docker build --platform linux/amd64 -t ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:${{ github.sha }} .
          docker tag ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:${{ github.sha }} ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:latest
          docker push ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:${{ github.sha }}
          docker push ${{ env.ECR_REGISTRY }}/grafana-llm-gateway:latest

  # Deploy to POC (manual trigger or main branch)
  deploy-poc:
    name: Deploy to POC
    runs-on: ubuntu-latest
    needs: [terraform-validate, build-grafana]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: poc
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Force deploy Grafana
        run: |
          aws ecs update-service \
            --cluster kong-llm-gateway-poc \
            --service grafana \
            --force-new-deployment \
            --region ${{ env.AWS_REGION }}

      - name: Wait for deployment
        run: |
          aws ecs wait services-stable \
            --cluster kong-llm-gateway-poc \
            --services grafana \
            --region ${{ env.AWS_REGION }}
