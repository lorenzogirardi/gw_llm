name: ECS Scale Service

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'ECS Service'
        required: true
        type: choice
        options:
          - litellm
          - langfuse
          - grafana
          - victoria-metrics
      desired_count:
        description: 'Desired task count (0 to stop)'
        required: true
        type: choice
        options:
          - '0'
          - '1'
          - '2'
          - '3'

env:
  AWS_REGION: us-west-1
  ECS_CLUSTER: kong-llm-gateway-poc

jobs:
  scale:
    name: Scale ECS Service
    runs-on: ubuntu-latest
    environment: poc
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get current count
        id: current
        run: |
          CURRENT=$(aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ inputs.service }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].desiredCount' --output text)
          echo "count=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current desired count: $CURRENT"

      - name: Scale service
        run: |
          echo "Scaling ${{ inputs.service }} from ${{ steps.current.outputs.count }} to ${{ inputs.desired_count }}"

          aws ecs update-service \
            --cluster ${{ env.ECS_CLUSTER }} \
            --service ${{ inputs.service }} \
            --desired-count ${{ inputs.desired_count }} \
            --region ${{ env.AWS_REGION }} \
            --query 'service.{Service:serviceName,DesiredCount:desiredCount}' \
            --output table

      - name: Wait for stabilization
        if: inputs.desired_count != '0'
        run: |
          echo "Waiting for service to stabilize..."
          aws ecs wait services-stable \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ inputs.service }} \
            --region ${{ env.AWS_REGION }}
          echo "Service scaled successfully"

      - name: Verify final state
        run: |
          echo ""
          echo "=== Final State ==="
          aws ecs describe-services \
            --cluster ${{ env.ECS_CLUSTER }} \
            --services ${{ inputs.service }} \
            --region ${{ env.AWS_REGION }} \
            --query 'services[0].{Service:serviceName,Desired:desiredCount,Running:runningCount,Pending:pendingCount}' \
            --output table
