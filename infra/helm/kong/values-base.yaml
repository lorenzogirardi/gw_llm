# Kong Gateway Helm Values - Base Configuration
#
# This file contains common configuration shared across all environments.
# Environment-specific values should override these in values-{env}.yaml

# Image configuration
image:
  repository: kong
  tag: "3.6"
  pullPolicy: IfNotPresent

# DB-less mode configuration
env:
  database: "off"
  declarative_config: "/kong_dbless/kong.yaml"
  plugins: "bundled,bedrock-proxy,token-meter,ecommerce-guardrails"
  # Performance tuning for LLM proxying
  nginx_proxy_proxy_buffer_size: "128k"
  nginx_proxy_proxy_buffers: "4 256k"
  nginx_proxy_proxy_busy_buffers_size: "256k"
  # Logging
  log_level: "info"
  # Anonymous reports
  anonymous_reports: "off"

# Declarative config - mounted from ConfigMap
dblessConfig:
  configMap: kong-declarative-config

# Ingress Controller
ingressController:
  enabled: true
  installCRDs: true
  ingressClass: kong
  watchNamespaces: []

# Proxy service configuration
proxy:
  enabled: true
  type: LoadBalancer
  http:
    enabled: true
    containerPort: 8000
    servicePort: 80
  tls:
    enabled: true
    containerPort: 8443
    servicePort: 443
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: nlb
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip

# Admin API - disabled by default for security
admin:
  enabled: false
  type: ClusterIP
  http:
    enabled: false
  tls:
    enabled: false

# Status endpoint for health checks
status:
  enabled: true
  http:
    enabled: true
    containerPort: 8100

# Prometheus metrics
serviceMonitor:
  enabled: true
  labels:
    release: prometheus

# Pod configuration
deployment:
  kong:
    enabled: true

# Pod labels
podLabels:
  app.kubernetes.io/component: api-gateway
  app.kubernetes.io/part-of: llm-gateway

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8100"

# Security context
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000

containerSecurityContext:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  runAsNonRoot: true
  runAsUser: 1000

# Liveness and readiness probes
livenessProbe:
  httpGet:
    path: /status
    port: status
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /status/ready
    port: status
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 3

# Topology spread constraints for HA
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: kong

# Affinity - prefer spreading across nodes
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchLabels:
              app.kubernetes.io/name: kong
          topologyKey: kubernetes.io/hostname

# Custom plugins configuration
# Plugins are mounted from ConfigMaps created separately
extraConfigMaps:
  - name: kong-declarative-config
    mountPath: /kong_dbless
  - name: kong-plugin-bedrock-proxy
    mountPath: /opt/kong/plugins/bedrock-proxy
  - name: kong-plugin-token-meter
    mountPath: /opt/kong/plugins/token-meter
  - name: kong-plugin-ecommerce-guardrails
    mountPath: /opt/kong/plugins/ecommerce-guardrails
